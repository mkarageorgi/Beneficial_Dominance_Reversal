---
title: "Comparison of malathion LD50 and LD90 between Ace genotypes"
author: "Marianna Karageorgi"
date: "2025-05-07"
---

# 1. Data

Starting July 4th 2023, eggs of each D.melanogaster genotype (SS, R1R1, R2R2, R3R3, SR1, SR2, SR3) were exposed to malathion at a range of concentrations diluted in regular Drosophila media (2 trials, 50 eggs/trial).

• dose_ppm = ppm concentration of malathion

• Total = number of eggs exposed per trial

• Alive = number of eggs that survived to adulthood

• Dead = number of eggs that did not survive to adulthood

### Data Wrangling

```{r}
library(tidyverse)
library(data.table)
```

```{r}
# data
viability.range_malathion = fread("./data/Resistance_Data_FINAL.csv")

data.resistance = viability.range_malathion %>%
  
  #create columns alive, total, and dead
  mutate(Alive = rowSums(viability.range_malathion[, 6:15], na.rm = TRUE), 
         Total = 50, 
         Dead = Total - Alive) %>%
    
  mutate(Survival = Alive / Total * 100) %>%
    
  dplyr::rename(Dose = `Dose_(ppm)`) %>%
  
  dplyr::select(Genotype, Replicate, Dose, Alive, Dead, Total, Survival) 
  
data.resistance$Genotype = factor(data.resistance$Genotype,
                       levels=c("SS","SR1","SR2","SR3","R1R1", "R2R2", "R3R3"))
```

### Summary stats

```{r}
resistance.data.summary = data.resistance %>%
  
  # group replicates 
  group_by(Genotype, Dose) %>%
  
  #summary statistics
  dplyr::summarize(mean_Survival = mean(Survival), 
                   replicates = n(), sd = sd(Survival), 
                   # se = sd / sqrt(2), # i'm not calculating se because size of groups is unequal 
                   .groups = "keep") 
```

### Dose-Response Data: Exploratory Data Analysis

```{r}
library(ggpubr) 
library(ggthemes)

# Define the custom colors for each genotype
genotype_labels = c("S/S", "S/R1", "R1/R1", "S/R2","R2/R2", "S/R3", "R3/R3")
  
# Define the custom colors for the palette
genotype_colors = c("black", "#FCCC1A","#8601AF","#FE2712",  "#FCCC1A", "#8601AF",   "#FE2712")

# Define the linetypes for the lines
linetypes = c(1, 2, 2, 2, 1, 1, 1)

# Define the shapes for each genotype
genotype_shapes = c(16, 1, 16, 1, 16, 1, 16)

resistance_plot = ggplot(data = resistance.data.summary, 
                        aes(x = Dose, y = mean_Survival, color = Genotype, linetype = Genotype)) + 
  
  #this plots for mean of Survival at each dose per Genotype
  geom_line(aes(x = Dose, y = mean_Survival), size = 1, alpha = 1) +
   
  #this plots for standard error of Survival at each dose per Genotype
  geom_errorbar(aes(ymin=mean_Survival-sd, ymax=mean_Survival + sd), width = 0.2) +
  
  # Map the colors to the genotypes
  scale_color_manual(name = "Ace genotype",
                    labels = genotype_labels,
                    values = genotype_colors) +
  
  # Map the linetypes to the genotypes
  scale_linetype_manual(name = "Ace genotype",
                        labels = genotype_labels,
                        values = linetypes) +

  
  scale_x_continuous(breaks=seq(0, 30, 2.5),
                     limits = c(0, 30)) +
  
  scale_y_continuous(breaks=seq(0, 100, 20)) +
  
  labs(x= "Dose (ppm)", y = "Egg to adult viability (%)") +
  
  theme_classic() +
  theme(
    # Increase the size of the axis titles
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    
    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 13, angle = 90, vjust = 0.5),
    axis.text.y = element_text(size = 15),
    
     # Position the legend inside the plot in the upper left hand corner
    legend.position = c(0.99, 0.99),
        legend.background = element_rect(fill = "transparent"),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(3, 3, 3, 3),
        legend.text.align = 0,
        legend.text = element_text(size = 10)
  ) 
  

resistance_plot
```

# 2. Model data

```{r}
library(drc)
library(broom)
```

-   Fit logistic dose-response curves to the resistance data of each Ace genotype. The drm() function is the key function in the drc package for fitting dose-response curves. Survival is the response variable (y-axis) and Dose is the dose (x-axis). Genotype is the classification variable. data= data.resistanceidentifies the name of the data file. fct=L.4() is the argument for the logistic curve with four parameters. Here, we fixed two of the parameters, the lower and upper limits, at 0 and 100, respectively. Notice that the drm() function does not produce an output. All the information on the model fit is stored in the object under our defined name resistance.data.model. This will be read by further commands.

-   The summary() function provides a summary of the parameter estimates for the resistance.data.model. In this case, we have constrained the lower and upper limits to 0 and 100, respectively for all datasets. The parameters that are estimated are the slope (b) and the effective dose (e) and their standard errors. The p-values tell us if the parameters are different from zero.

-   The ED() function calculates the estimated effective dose for the resistance data based on the fitted model.

-   Notice that we plot data as egg-to-adult viability instead of egg-to-adult mortality. The implication is that the dose that while LD50= ED50 because 50% mortality = 50% survival.

```{r}
# the dose-response model
model.R = drm(Survival ~ Dose, Genotype,
              data = data.resistance, 
              fct = L.4(fixed = c(NA, 0, 100, NA)))

summary(model.R)
ED(model.R, c(50))
```

### Predict egg-adult viability using model

```{r}
# grid of doses and genotypes for which we want predictions
new_doses = expand.grid(Dose = seq(0, 30, by = 0.2), Genotype = unique(data.resistance$Genotype))

# predict survival using the resistance data model
predictions.R = predict(model.R, newdata = new_doses, type = "response")

# attach the predictions to the new_doses data frame
new_doses$Survival = predictions.R
```

### Predict egg-adult viability at 2.5ppm and 7.5ppm for simulations and other relevant concentrations

```{r}
# Specify the doses for which predictions are needed
doses = c(1.5, 2.5, 5, 7.5, 10, 15, 20)

# Create a grid of these specific doses and genotypes for which we want predictions
specific.doses = expand.grid(Dose = doses, Genotype = unique(data.resistance$Genotype))

# Predict survival using the resistance data model
predictions.specific.doses.R = predict(model.R, newdata = specific.doses, type = "response")

# Attach the predictions to the specific_doses data frame
specific.doses$Survival = round(predictions.specific.doses.R,2)

specific.doses 

write_csv(specific.doses, "./data/drc.model.viability.malathion.csv")
```

### Plot dose response curves

```{r}
genotype_labels = c(
  expression("S/S"),
  expression("S/R1"),
  expression("S/R2"),
  expression("S/R3"),
  expression("R1/R1"),
  expression("R2/R2"),
  expression("R3/R3")
  )

# Define the custom colors for each genotype
genotype_colors = c("#165094", "#E2BB9B" ,"#EDA09E","#A97DAA","#ce8e58", "#e1615e",  "#702771")


# Define the linetypes for the lines
linetypes = c(1, 2, 2, 2, 1, 1, 1)

# Define the shapes for each genotype
genotype_shapes = c(16, 15, 15,15, 17,17, 17)

Ace.resistance.curves.R = ggplot(data = data.resistance,
       aes(x = Dose, y = Survival, group= Genotype, color= Genotype, linetype = Genotype)) + 
  
  # Annotate to indicate viability at 2.5 and 7.5ppm
annotate("rect", xmin=2.3, xmax=2.7, ymin=-Inf, ymax=Inf, alpha=0.8, fill="#fdd28d") +
annotate("rect", xmin=7.3, xmax=7.7, ymin=-Inf, ymax=Inf, alpha=0.8, fill="#fdd28d") +
  
  # Annotate to indicate LD50 and LD90
  geom_hline(yintercept = 10, color ="grey" ) +
  geom_hline(yintercept = 50, color ="grey") +
  
  # Add text annotations for LD50 and LD90
  annotate("text", x = 0, y = 53, label = "LD50", color = "grey", size = 3.5) +
  annotate("text", x = 0, y = 13, label = "LD90", color = "grey", size = 3.5) +

  geom_point(aes(color=Genotype, shape = Genotype), size = 2) + 
  
  #plot model predictions
  geom_line(data= new_doses, aes(x = Dose, y = Survival, color = Genotype, linetype = Genotype), size = 1) +
  
  
  # Map the colors to the genotypes
  scale_color_manual(name = "Ace genotype",
                    labels = genotype_labels,
                    values = genotype_colors) +
  
  # Map the linetypes to the genotypes
  scale_linetype_manual(name = "Ace genotype",
                        labels = genotype_labels,
                        values = linetypes) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(name = "Ace genotype",
                        labels = genotype_labels,
                        values = genotype_shapes) +

  scale_x_continuous(breaks=seq(0, 30, 2.5),
                     limits = c(-0.5, 30)) +
  
  scale_y_continuous(breaks=seq(0, 100, 10),
                     limits = c(-5,100)) +
  
  labs(title= "", x = "Dose (ppm)",  y = "Egg to adult viability (%)") + 
  
  theme_classic() +
  
  theme(
    # Increase the size of the axis titles
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    
    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 13, angle = 90, vjust = 0.5),
    axis.text.y = element_text(size = 15),
    
     # Position the legend inside the plot in the upper left hand corner
    legend.position = c(1, 0.99),
        legend.background = element_rect(fill = "white"),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(3, 3, 3, 3),
        legend.text.align = 0,
        legend.text = element_text(size = 10)
  ) 


Ace.resistance.curves.R
ggsave("./plots/Ace.resistance.curves.R.png", Ace.resistance.curves.R, width = 6, height = 4)
```

# 3. Metrics & Bootstrap for LD50

**Additivity: Comparison between SR vs. (SS+RR)/2**

Additivity is calculated as the difference between the SR genotype and the average of SS and RR genotypes. It can be compared to the expected value under additivity.

-   Expected value under additivity:

    SR- (SS+RR)/2 = proportion_SR -(proportion_SS+proportion_RR)/2

-   Use bootstrapping to calculate confidence intervals for the additivity estimate.

-   Significance testing with two one-sided tests: H0 = the estimate for additivity is 0. Ha1 = the estimate for dominance is higher than 0 Ha2 = the estimate for dominance is lower than 0.

**Selection coefficient: Estimate ratio (RR - SS)/ SS**

The selection coefficient is the ratio of the difference between RR and SS genotypes to the SS genotype. This parameter indicates how selection affects the fitness of the resistant genotype compared to the sensitive genotype.

-   Estimate ratio (RR-SS)/SS = (proportion_RR-proportion_SS)/proportion_SS

-   Use bootstrapping to calculate confidence intervals for the selection coefficient

-   Significance testing with two-sided t-test: H0 = the estimate for selection equals to 0. Ha = the estimate for selection is different from 0.

**Dominance coefficient: Estimate (SR−SS)/(RR−SS) (h)**

The dominance coefficient measures the degree to which the heterozygous genotype (SR) exhibits fitness that is intermediate between the homozygous genotypes (SS and RR).

-   Estimate ratio (proportion_SR-proportion_SS)/(proportion_RR-proportion_SS)

-   Use bootstrapping methods to calculate confidence intervals for the dominance coefficient

-   Significance testing with two one-sided t-test: H0 = the estimate for dominance is 0.5. Ha1 = the estimate for dominance is higher than 0.5. Ha2 = the estimate for dominance is lower than 0.5

```{r}
library(boot)

# bootstrap & estimate metrics

# bootstrap function
metrics.boot = function(data, original) { 
  # Create bootstrap sample
  d = data %>%
    group_by(Dose, Genotype) %>%
    # randomly select two rows from each Dose-Genotype group, sampling with replacement
    slice_sample(n = 2, replace = TRUE) %>% # n = number of reps in Dose-Genotype group
    ungroup()
  
  # Fit model to bootstrap sample 
  fit = drm(Survival ~ Dose, Genotype,
            data = d, 
            fct = L.4(fixed = c(NA, 0, 100, NA)))
  
  # Extract ED50 values
  result = ED(fit, c(50))

  # Get ED50 values for each genotype to calculate metrics for each boot
  r1r1 = result["e:R1R1:50", "Estimate"]
  r2r2 = result["e:R2R2:50", "Estimate"]
  r3r3 = result["e:R3R3:50", "Estimate"]
  sr1 = result["e:SR1:50", "Estimate"]
  sr2 = result["e:SR2:50", "Estimate"]
  sr3 = result["e:SR3:50", "Estimate"]
  ss = result["e:SS:50", "Estimate"]
  
  # Calculate all metrics for each R allele for each boot
  # For R1
  ss_sr1_diff = ss - sr1
  ss_r1r1_diff = ss - r1r1
  sr1_r1r1_diff = sr1 - r1r1
  dev.add.r1 = sr1 - (ss + r1r1) / 2
  s.r1 = (r1r1 - ss) / ss
  h.r1 = (sr1 - ss) / (r1r1 - ss)
  # For R2
  ss_sr2_diff = ss - sr2
  ss_r2r2_diff = ss - r2r2
  sr2_r2r2_diff = sr2 - r2r2
  dev.add.r2 = sr2 - (ss + r2r2) / 2
  s.r2 = (r2r2 - ss) / ss
  h.r2 = (sr2 - ss) / (r2r2 - ss)
  # For R3
  ss_sr3_diff = ss - sr3
  ss_r3r3_diff = ss - r3r3
  sr3_r3r3_diff = sr3 - r3r3
  dev.add.r3 = sr3 - (ss + r3r3) / 2
  s.r3 = (r3r3 - ss) / ss
  h.r3 = (sr3 - ss) / (r3r3 - ss)
  
  # Return with explicit names
  result_vector = c(r1r1, r2r2, r3r3, sr1, sr2, sr3, ss, 
                   dev.add.r1, dev.add.r2, dev.add.r3,
                   s.r1, s.r2, s.r3,
                   h.r1, h.r2, h.r3,
                   ss_sr1_diff, ss_sr2_diff, ss_sr3_diff,
                   ss_r1r1_diff, ss_r2r2_diff, ss_r3r3_diff,
                   sr1_r1r1_diff, sr2_r2r2_diff, sr3_r3r3_diff)
  
  names(result_vector) = c("ED50_R1R1", "ED50_R2R2", "ED50_R3R3",
                          "ED50_SR1", "ED50_SR2", "ED50_SR3", "ED50_SS",
                          "DevAdd_R1", "DevAdd_R2", "DevAdd_R3",
                          "S_R1", "S_R2", "S_R3",
                          "H_R1", "H_R2", "H_R3",
                          "diff_SS.SR1", "diff_SS.SR2", "diff_SS.SR3",
                          "diff_SS.R1R1", "diff_SS.R2R2", "diff_SS.R3R3",
                          "diff_SR1.R1R1", "diff_SR2.R2R2", "diff_SR3.R3R3")

  return(result_vector)
}

# run the bootstrap
set.seed(123)
nboot=1000
result = boot(data = data.resistance,
               statistic = metrics.boot,
               R = nboot)  # R for number of bootstraps

result$t0 # original estimate based on data
result$t  # boot samples estimates

summary(result)
tidy(result)
```

```{r}
### LD50s ###

# Report the original estimate (result$t0) based on the data  
# Use the 2.5% and 97.5% quantiles of the bootstrap distribution (result$t) for the 95% ci

# Process bootstrap results into a single LD50 table
ld50.results = function(result) {
  # Define genotypes and indices
  genotypes = c("R1R1", "R2R2", "R3R3", "SR1", "SR2", "SR3", "SS")
  ld50_indices = 1:7
  
  # Process LD50 values
  ld50_table = do.call(rbind, lapply(1:length(genotypes), function(i) {
    # Extract values
    original = result$t0[i]
    boot_samples = result$t[, i]
    ci = quantile(boot_samples, c(0.025, 0.975))
    
    data.frame(
      Genotype = genotypes[i],
      Estimate = original,
      Lower.CI = ci[1],
      Upper.CI = ci[2]
    )
  }))
  
  return(ld50_table)
}

# Get the LD50 data frame
ld50 = ld50.results(result)
ld50
```

```{r}
### DIFFERENCES & METRICS ####

# Report the original estimate (result$t0) based on the data  
# Use the 2.5% and 97.5% quantiles of the bootstrap distribution (result$t) for the 95% ci
# Report the p-value calculated from the bootstrap distribution

# First, define the p.value function
p.value = function(boot_samples, null_value) {
  p_less = mean(boot_samples <= null_value, na.rm = TRUE)
  p_greater = mean(boot_samples >= null_value, na.rm = TRUE)
  return(2 * min(p_less, p_greater)) # which tail is more extreme
}

# Then define metrics.results
metrics.results = function(result) {
  # Define alleles
  alleles = c("R1", "R2", "R3")
  
  # Define all metrics
  all_metrics = list(
    
    # Derived metrics
    list(type = "DevAdd", name = "Additivity", indices = 8:10, null_value = 0),
    list(type = "S", name = "Selection coefficient", indices = 11:13, null_value = 0),
    list(type = "H", name = "Dominance coefficient", indices = 14:16, null_value = 0.5),
    
    # Derived differences
    list(type = "diff_SS.SR", name = "SS-SR difference", indices = 17:19, null_value = 0),
    list(type = "diff_SS.RR", name = "SS-RR difference", indices = 20:22, null_value = 0),
    list(type = "diff_SR.RR", name = "SR-RR difference", indices = 23:25, null_value = 0)
  )
  
  # Process metrics
  metrics_table = do.call(rbind, lapply(1:length(all_metrics), function(m) {
    metric = all_metrics[[m]]
    
    do.call(rbind, lapply(1:length(alleles), function(a) {
      idx = metric$indices[a]
      original = result$t0[idx]
      boot_samples = result$t[, idx]
      ci = quantile(boot_samples, c(0.025, 0.975), na.rm = TRUE)
      p_val = p.value(boot_samples, metric$null_value)
      
      data.frame(
        Metric = metric$name,
        Allele = alleles[a],
        Estimate = original,
        Lower.CI = ci[1],
        Upper.CI = ci[2],
        p.value = p_val
      )
    }))
  }))
  
  # Return the formatted table
  return(metrics_table)
}

# Now call metrics.results
metrics = metrics.results(result)
metrics[metrics$p.value==0,]$p.value= 1/nboot # this is so that p.value is not 0
```

# 4. Table for LD50

```{r}
# combine dataframes for the final table
ld50.format = ld50 %>%
  rownames_to_column(var = "column") %>% separate(column, into = c("Metric", "Genotype.Allele"), sep = "_") %>%
  dplyr::select(Genotype.Allele, Metric, Estimate, Lower.CI, Upper.CI) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

metrics.format =  metrics %>%
  rownames_to_column(var = "column") %>% separate(column, into = c("Metric", "Genotype.Allele"), sep = "_") %>%
  dplyr::select(-Allele) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

all.metrics = bind_rows(ld50.format, metrics.format) %>%
  mutate(Genotype.Allele = factor(Genotype.Allele, 
                                  levels = c("SS", "SR1", "SR2", "SR3", "R1R1", "R2R2", "R3R3", 
                                             "SS.SR1","SS.SR2","SS.SR3", "SS.R1R1","SS.R2R2","SS.R3R3", "SR1.R1R1","SR2.R2R2","SR3.R3R3",
                                             "R1", "R2", "R3")),
         Metric = factor(Metric, 
                         levels = c("ED50","diff","DevAdd", "S", "H"))) %>%
  arrange(Metric, Genotype.Allele)
```

```{r}
library(kableExtra)
library(htmltools)
library(webshot)
```

```{r}
all.metrics.table = all.metrics %>%
  unite(col = "Parameter", Genotype.Allele, Metric, sep = "_") %>%
  rename(LD50 = Estimate) %>%
  
  mutate(Parameter = case_when(
    
    Parameter == "SS_ED50" ~ "SS",
    Parameter == "SR1_ED50" ~ "SR1",
    Parameter == "R1R1_ED50" ~ "R1R1",
    Parameter == "SR2_ED50" ~ "SR2",
    Parameter == "R2R2_ED50" ~ "R2R2",
    Parameter == "SR3_ED50" ~ "SR3",
    Parameter == "R3R3_ED50" ~ "R3R3",

    Parameter == "SS.SR1_diff" ~ "SS vs. SR1",
    Parameter == "SS.R1R1_diff" ~ "SS vs. R1R1",
    Parameter == "SR1.R1R1_diff" ~ "SR1 vs. R1R1",
    Parameter == "SS.SR2_diff" ~ "SS vs. SR2",
    Parameter == "SS.R2R2_diff" ~ "SS vs. R2R2",
    Parameter == "SR2.R2R2_diff" ~ "SR2 vs. R2R2",
    Parameter == "SS.SR3_diff" ~ "SS vs. SR3",
    Parameter == "SS.R3R3_diff" ~ "SS vs. R3R3",
    Parameter == "SR3.R3R3_diff" ~ "SR3 vs. R3R3",

    Parameter == "R1_DevAdd" ~ "SR1 - (SS + R1R1)/2 (additivity)",
    Parameter == "R2_DevAdd" ~ "SR2 - (SS + R2R2)/2 (additivity)",
    Parameter == "R3_DevAdd" ~ "SR3 - (SS + R3R3)/2 (additivity)",

    Parameter == "R1_S" ~ "(R1R1 - SS) / SS (selection, s)",
    Parameter == "R2_S" ~ "(R2R2 - SS) / SS (selection, s)",
    Parameter == "R3_S" ~ "(R3R3 - SS) / SS (selection, s)",

    Parameter == "R1_H" ~ "(SR1 - SS) / (R1R1 - SS) (dominance, h)",
    Parameter == "R2_H" ~ "(SR2 - SS) / (R2R2 - SS) (dominance, h)",
    Parameter == "R3_H" ~ "(SR3 - SS) / (R3R3 - SS) (dominance, h)")) %>%
   #replace NA with -
  mutate(across(everything(), ~replace(., is.na(.), "-")))


table.kable = kable(x = all.metrics.table, digits = 4, align = 'l',
                       caption = "<b>Effect estimates from logistic model analysis for LD50 </b>") %>%
                       kable_classic(full_width = TRUE, html_font = "Times New Roman", font_size = 16) %>%
                       kable_styling(latex_options = c("striped", "hold_position"), position = "center") %>%
                       row_spec(0, bold = TRUE, font_size = 16) %>%  # Make header bold and set font size
                       row_spec(1:nrow(all.metrics.table), font_size = 16)  # Smaller font for values

    


table.kable

# Save the table as an HTML file
save_kable(table.kable, file = "./tables/table_LD50.html")

# Use webshot to convert HTML to PDF
webshot("./tables/table_LD50.html", file = "./tables/table_LD50.pdf")
```

# 5. Plots for LD50

## 5.1 Ace R1 genotype

```{r}
library("ggpubr")

# plot for R1

genotype_labels = c("SS","SR1","R1R1")

# Define the custom colors for each genotype
genotype_colors = c("#165094", "#E2BB9B","#ce8e58")

# Define the shapes for each genotype
genotype_shapes = c(16, 15, 17)


R1_ld50 = ggplot() +
  
  annotate("segment", x = 1, xend = 3, 
           y = all.metrics %>% filter(Genotype.Allele == "SS" & Metric == "ED50") %>% pull(Estimate), 
           yend = all.metrics %>% filter(Genotype.Allele == "R1R1" & Metric == "ED50") %>% pull(Estimate),  
           colour = "#ce8e58", size=0.5, alpha=0.5) +
  
  # add a line for SS mean
  geom_hline(yintercept = all.metrics %>% filter(Genotype.Allele == "SS" & Metric == "ED50") %>% pull(Estimate), 
             color = "black", linetype = "solid", size = 0.25) +
  
  # This plots the original ld50 value for each genotype
  geom_point(data = all.metrics %>% filter(Genotype.Allele %in% c("SS","SR1", "R1R1")),
              aes(x=Genotype.Allele, y = Estimate, # estimate is ED50
                  color = Genotype.Allele, shape = Genotype.Allele), size = 8, alpha = 1) +

  
  # This plots the confidence intervals for each genotype
  geom_errorbar(data = all.metrics %>% filter(Genotype.Allele %in% c("SS","SR1", "R1R1")),
                aes(x=Genotype.Allele, ymin = Lower.CI, ymax = Upper.CI, 
                    color = Genotype.Allele), width = 0) +
 
  # Map the colors to the genotypes
  scale_color_manual(values = genotype_colors) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(values = genotype_shapes) +
  
  # Add the s and h coefficients for R1
  geom_text(aes(x = 0.7, y = 15, 
              label = "s = 0.45 (-0.18, 0.53) \nh = 1.77 (-7432, 298)"), 
          size = 8, hjust = 0, vjust = 1) +
  
  scale_y_continuous(breaks = seq(0,15,2.5), 
                     limits = c(0,15)) +
  
  scale_x_discrete(labels = genotype_labels) +
  
  labs(x = "", y = expression(LD[50]~", ppm")) +
  
  theme_classic() +
  
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
 #   panel.background= element_rect(color ="#FCCC1A", size = 2),
    
    # Increase the size of the axis titles
    axis.title.y = element_text(size = 24),

    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 20),
 
    # No legend
    legend.position = "none")


R1_ld50
ggsave("./plots/R1_ld50.png", width = 5 , height = 5)
```

## 5.2 Ace R2 genotypes

```{r}
# plot for R2

genotype_labels = c("SS","SR2","R2R2")

# Define the custom colors for each genotype
genotype_colors = c("#165094",  "#e1615e", "#e1615e")


# Define the shapes for each genotype
genotype_shapes = c(16, 15, 17)



R2_ld50 = ggplot() +
  
  annotate("segment", x = 1, xend = 3, 
           y = all.metrics %>% filter(Genotype.Allele == "SS" & Metric == "ED50") %>% pull(Estimate), 
           yend = all.metrics %>% filter(Genotype.Allele == "R2R2" & Metric == "ED50") %>% pull(Estimate),  
           colour = "#e1615e", size=0.5, alpha=0.5) +
  
  # add a line for SS mean
  geom_hline(yintercept = all.metrics %>% filter(Genotype.Allele == "SS" & Metric == "ED50") %>% pull(Estimate), 
             color = "black", linetype = "solid", size = 0.25) +
  
  # This plots individual values for each genotype
  geom_point(data = all.metrics %>% filter(Genotype.Allele %in% c("SS","SR2", "R2R2")),
              aes(x=Genotype.Allele, y = Estimate, # estimate is ED50
                  color = Genotype.Allele, shape = Genotype.Allele), size = 8, alpha = 1) +
  
  
  # This plots the mean and standard error for each genotype
  geom_errorbar(data = all.metrics %>% filter(Genotype.Allele %in% c("SS","SR2", "R2R2")),
                aes(x=Genotype.Allele, ymin = Lower.CI, ymax = Upper.CI, 
                    color = Genotype.Allele), width = 0) +
 
  # Map the colors to the genotypes
  scale_color_manual(values = genotype_colors) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(values = genotype_shapes) +
  
 # Add the s and h coefficients for R2
  geom_text(aes(x = 0.7, y = 15, 
              label = "s = 6.48 (3.68, 6.65)*** \nh = 0.82 (0.72, 0.89)***"), 
          size = 8, hjust = 0, vjust = 1) +
  
  scale_y_continuous(breaks = seq(0,15,2.5), 
                     limits = c(0,15)) +
  
  scale_x_discrete(labels = genotype_labels) +
  
  labs(x = "", y = expression(LD[50]~", ppm")) +
  
  theme_classic() +
  
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
#    panel.background= element_rect(color ="#8601AF", size = 2),
    
   # Increase the size of the axis titles
    axis.title.y = element_text(size = 24),

    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 20),

    # No legend
    legend.position = "none")


R2_ld50 
ggsave("./plots/R2_ld50.png", width = 5 , height = 5)
```

## 5.3 Ace R3 genotypes

```{r}
# plot for R3

genotype_labels = c("SS","SR3","R3R3")

# Define the custom colors for each genotype
genotype_colors = c("#165094",  "#702771", "#702771")

# Define the shapes for each genotype
genotype_shapes = c(16, 15, 17)


R3_ld50 = ggplot() +
  
  annotate("segment", x = 0.7, xend = 3, 
            y = all.metrics %>% filter(Genotype.Allele == "SS" & Metric == "ED50") %>% pull(Estimate), 
           yend = all.metrics %>% filter(Genotype.Allele == "R3R3" & Metric == "ED50") %>% pull(Estimate),   
           colour =  "#702771", size=0.5, alpha=0.5) +
  
  # add a line for SS mean
  geom_hline(yintercept = all.metrics %>% filter(Genotype.Allele == "SS" & Metric == "ED50") %>% pull(Estimate), 
             color = "black", linetype = "solid", size = 0.25) +
  
  # This plots individual values for each genotype
  geom_point(data = all.metrics %>% filter(Genotype.Allele %in% c("SS","SR3", "R3R3")),
              aes(x=Genotype.Allele, y = Estimate, # estimate is ED50
                  color = Genotype.Allele, shape = Genotype.Allele), size = 8, alpha = 1) +
  
  
  # This plots the standard error for each genotype
  geom_errorbar(data = all.metrics %>% filter(Genotype.Allele %in% c("SS","SR3", "R3R3")),
                aes(x=Genotype.Allele, ymin = Lower.CI, ymax = Upper.CI, 
                    color = Genotype.Allele), width = 0) +
 
  # Map the colors to the genotypes
  scale_color_manual(values = genotype_colors) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(values = genotype_shapes) +
  
  # Add the s and h coefficients for R3
  geom_text(aes(x = 0.7, y = 15, 
              label = "s = 9.09 (5.18, 9.10)*** \nh = 0.81 (0.70, 0.89)***"), 
          size = 8, hjust = 0, vjust = 1) +
  
  scale_y_continuous(breaks = seq(0,15,2.5), 
                     limits = c(0,15)) +
  
  scale_x_discrete(labels = genotype_labels) +
  
  labs(x = "", y = expression(LD[50]~", ppm")) +

  
  theme_classic() +
  
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
#    panel.background= element_rect(color ="#FE2712", size = 2),
    
    # Increase the size of the axis titles
    axis.title.y = element_text(size = 24),

    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 20),

    # No legend
    legend.position = "none")


R3_ld50 
ggsave("./plots/R3_ld50.png", width = 5 , height = 5)
```

# 6. Metrics & Bootstrap for LD90 (ED10)

```{r}
library(boot)

# bootstrap & estimate metrics

# bootstrap function
metrics.boot.10 = function(data, original) { 
  # Create bootstrap sample
  d = data %>%
    group_by(Dose, Genotype) %>%
    # randomly select two rows from each Dose-Genotype group, sampling with replacement
    slice_sample(n = 2, replace = TRUE) %>% # n = number of reps in Dose-Genotype group
    ungroup()
  
  # Fit model to bootstrap sample 
  fit = drm(Survival ~ Dose, Genotype,
            data = d, 
            fct = L.4(fixed = c(NA, 0, 100, NA)))
  
  # Extract ED50 values
  result = ED(fit, c(10))

  # Get ED50 values for each genotype to calculate metrics for each boot
  r1r1 = result["e:R1R1:10", "Estimate"]
  r2r2 = result["e:R2R2:10", "Estimate"]
  r3r3 = result["e:R3R3:10", "Estimate"]
  sr1 = result["e:SR1:10", "Estimate"]
  sr2 = result["e:SR2:10", "Estimate"]
  sr3 = result["e:SR3:10", "Estimate"]
  ss = result["e:SS:10", "Estimate"]
  
  # Calculate all metrics for each R allele for each boot
  # For R1
  ss_sr1_diff = ss - sr1
  ss_r1r1_diff = ss - r1r1
  sr1_r1r1_diff = sr1 - r1r1
  dev.add.r1 = sr1 - (ss + r1r1) / 2
  s.r1 = (r1r1 - ss) / ss
  h.r1 = (sr1 - ss) / (r1r1 - ss)
  # For R2
  ss_sr2_diff = ss - sr2
  ss_r2r2_diff = ss - r2r2
  sr2_r2r2_diff = sr2 - r2r2
  dev.add.r2 = sr2 - (ss + r2r2) / 2
  s.r2 = (r2r2 - ss) / ss
  h.r2 = (sr2 - ss) / (r2r2 - ss)
  # For R3
  ss_sr3_diff = ss - sr3
  ss_r3r3_diff = ss - r3r3
  sr3_r3r3_diff = sr3 - r3r3
  dev.add.r3 = sr3 - (ss + r3r3) / 2
  s.r3 = (r3r3 - ss) / ss
  h.r3 = (sr3 - ss) / (r3r3 - ss)
  
  # Return with explicit names
  result_vector = c(r1r1, r2r2, r3r3, sr1, sr2, sr3, ss, 
                   dev.add.r1, dev.add.r2, dev.add.r3,
                   s.r1, s.r2, s.r3,
                   h.r1, h.r2, h.r3,
                   ss_sr1_diff, ss_sr2_diff, ss_sr3_diff,
                   ss_r1r1_diff, ss_r2r2_diff, ss_r3r3_diff,
                   sr1_r1r1_diff, sr2_r2r2_diff, sr3_r3r3_diff)
  
  names(result_vector) = c("ED10_R1R1", "ED10_R2R2", "ED10_R3R3",
                          "ED10_SR1", "ED10_SR2", "ED10_SR3", "ED10_SS",
                          "DevAdd_R1", "DevAdd_R2", "DevAdd_R3",
                          "S_R1", "S_R2", "S_R3",
                          "H_R1", "H_R2", "H_R3",
                          "diff_SS.SR1", "diff_SS.SR2", "diff_SS.SR3",
                          "diff_SS.R1R1", "diff_SS.R2R2", "diff_SS.R3R3",
                          "diff_SR1.R1R1", "diff_SR2.R2R2", "diff_SR3.R3R3")

  return(result_vector)
}

# run the bootstrap
set.seed(123)
nboot=1000
result.10 = boot(data = data.resistance,
               statistic = metrics.boot.10,
               R = nboot)  # R for number of bootstraps

result.10$t0 # original estimate based on data
result.10$t  # boot samples estimates

summary(result.10)
tidy(result.10)
```

```{r}
### LD90s ###

# Report the original estimate (result$t0) based on the data  
# Use the 2.5% and 97.5% quantiles of the bootstrap distribution (result$t) for the 95% ci

# Process bootstrap results into a single LD50 table
ED10.results = function(result) {
  # Define genotypes and indices
  genotypes = c("R1R1", "R2R2", "R3R3", "SR1", "SR2", "SR3", "SS")
  ED10_indices = 1:7
  
  # Process ED10 values
  ED10_table = do.call(rbind, lapply(1:length(genotypes), function(i) {
    # Extract values
    original = result$t0[i]
    boot_samples = result$t[, i]
    ci = quantile(boot_samples, c(0.025, 0.975))
    
    data.frame(
      Genotype = genotypes[i],
      Estimate = original,
      Lower.CI = ci[1],
      Upper.CI = ci[2]
    )
  }))
  
  return(ED10_table)
}

# Get the LD50 data frame
ld90 = ED10.results(result.10)
ld90
```

```{r}
### DIFFERENCES & METRICS ####

# Report the original estimate (result$t0) based on the data  
# Use the 2.5% and 97.5% quantiles of the bootstrap distribution (result$t) for the 95% ci
# Report the p-value calculated from the bootstrap distribution

# First, define the p.value function
p.value = function(boot_samples, null_value) {
  p_less = mean(boot_samples <= null_value, na.rm = TRUE)
  p_greater = mean(boot_samples >= null_value, na.rm = TRUE)
  return(2 * min(p_less, p_greater))
}

# Then define metrics.results
ED10.metrics.results = function(result) {
  # Define alleles
  alleles = c("R1", "R2", "R3")
  
  # Define all metrics
  all_metrics = list(
    
    # Derived metrics
    list(type = "DevAdd", name = "Additivity", indices = 8:10, null_value = 0),
    list(type = "S", name = "Selection coefficient", indices = 11:13, null_value = 0),
    list(type = "H", name = "Dominance coefficient", indices = 14:16, null_value = 0.5),
    
    # Derived differences
    list(type = "diff_SS.SR", name = "SS-SR difference", indices = 17:19, null_value = 0),
    list(type = "diff_SS.RR", name = "SS-RR difference", indices = 20:22, null_value = 0),
    list(type = "diff_SR.RR", name = "SR-RR difference", indices = 23:25, null_value = 0)
  )
  
  # Process metrics
  metrics_table = do.call(rbind, lapply(1:length(all_metrics), function(m) {
    metric = all_metrics[[m]]
    
    do.call(rbind, lapply(1:length(alleles), function(a) {
      idx = metric$indices[a]
      original = result$t0[idx]
      boot_samples = result$t[, idx]
      ci = quantile(boot_samples, c(0.025, 0.975), na.rm = TRUE)
      p_val = p.value(boot_samples, metric$null_value)
      
      data.frame(
        Metric = metric$name,
        Allele = alleles[a],
        Estimate = original,
        Lower.CI = ci[1],
        Upper.CI = ci[2],
        p.value = p_val
      )
    }))
  }))
  
  # Return the formatted table
  return(metrics_table)
}

# Now call metrics.results
metrics.ld90 = ED10.metrics.results(result.10)
metrics.ld90[metrics.ld90$p.value==0,]$p.value= 1/nboot # this is so that p.value is not 0
```

# 7. Table LD90

```{r}
# combine dataframes for the final table
ld90.format = ld90 %>%
  rownames_to_column(var = "column") %>% separate(column, into = c("Metric", "Genotype.Allele"), sep = "_") %>%
  dplyr::select(Genotype.Allele, Metric, Estimate, Lower.CI, Upper.CI) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

metrics.ld90.format =  metrics.ld90 %>%
  rownames_to_column(var = "column") %>% separate(column, into = c("Metric", "Genotype.Allele"), sep = "_") %>%
  dplyr::select(-Allele) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

all.metrics.ld90 = bind_rows(ld90.format, metrics.ld90.format) %>%
  mutate(Genotype.Allele = factor(Genotype.Allele, 
                                  levels = c("SS", "SR1", "SR2", "SR3", "R1R1", "R2R2", "R3R3", 
                                             "SS.SR1","SS.SR2","SS.SR3", "SS.R1R1","SS.R2R2","SS.R3R3", "SR1.R1R1","SR2.R2R2","SR3.R3R3",
                                             "R1", "R2", "R3")),
         Metric = factor(Metric, 
                         levels = c("ED10","diff","DevAdd", "S", "H"))) %>%
  arrange(Metric, Genotype.Allele)
```

```{r}
library(kableExtra)
library(htmltools)
library(webshot)
```

```{r}
all.metrics.table.ld90 = all.metrics.ld90 %>%
  unite(col = "Parameter", Genotype.Allele, Metric, sep = "_") %>%
  rename(LD90 = Estimate) %>%
  
  mutate(Parameter = case_when(
    
    Parameter == "SS_ED10" ~ "SS",
    Parameter == "SR1_ED10" ~ "SR1",
    Parameter == "R1R1_ED10" ~ "R1R1",
    Parameter == "SR2_ED10" ~ "SR2",
    Parameter == "R2R2_ED10" ~ "R2R2",
    Parameter == "SR3_ED10" ~ "SR3",
    Parameter == "R3R3_ED10" ~ "R3R3",

    Parameter == "SS.SR1_diff" ~ "SS vs. SR1",
    Parameter == "SS.R1R1_diff" ~ "SS vs. R1R1",
    Parameter == "SR1.R1R1_diff" ~ "SR1 vs. R1R1",
    Parameter == "SS.SR2_diff" ~ "SS vs. SR2",
    Parameter == "SS.R2R2_diff" ~ "SS vs. R2R2",
    Parameter == "SR2.R2R2_diff" ~ "SR2 vs. R2R2",
    Parameter == "SS.SR3_diff" ~ "SS vs. SR3",
    Parameter == "SS.R3R3_diff" ~ "SS vs. R3R3",
    Parameter == "SR3.R3R3_diff" ~ "SR3 vs. R3R3",

    Parameter == "R1_DevAdd" ~ "SR1 - (SS + R1R1)/2 (additivity)",
    Parameter == "R2_DevAdd" ~ "SR2 - (SS + R2R2)/2 (additivity)",
    Parameter == "R3_DevAdd" ~ "SR3 - (SS + R3R3)/2 (additivity)",

    Parameter == "R1_S" ~ "(R1R1 - SS) / SS (selection, s)",
    Parameter == "R2_S" ~ "(R2R2 - SS) / SS (selection, s)",
    Parameter == "R3_S" ~ "(R3R3 - SS) / SS (selection, s)",

    Parameter == "R1_H" ~ "(SR1 - SS) / (R1R1 - SS) (dominance, h)",
    Parameter == "R2_H" ~ "(SR2 - SS) / (R2R2 - SS) (dominance, h)",
    Parameter == "R3_H" ~ "(SR3 - SS) / (R3R3 - SS) (dominance, h)")) %>%
   #replace NA with -
  mutate(across(everything(), ~replace(., is.na(.), "-")))


table.kable.ld90 = kable(x = all.metrics.table.ld90, digits = 4, align = 'l',
                       caption = "<b>Effect estimates from logistic model analysis for LD90 </b>") %>%
                       kable_classic(full_width = TRUE, html_font = "Times New Roman", font_size = 16) %>%
                       kable_styling(latex_options = c("striped", "hold_position"), position = "center") %>%
                       row_spec(0, bold = TRUE, font_size = 16) %>%  # Make header bold and set font size
                       row_spec(1:nrow(all.metrics.table), font_size = 16)  # Smaller font for values

    


table.kable.ld90

# Save the table as an HTML file
save_kable(table.kable.ld90, file = "./tables/table_LD90.html")

# Use webshot to convert HTML to PDF
webshot("./tables/table_LD90.html", file = "./tables/table_LD90.pdf")
```

# 8. References

1.  Drc package and the logistic model:

    <https://doseresponse.github.io/drc/reference/logistic.html>

2.  Bootstrapping model parameters:

    <https://rpubs.com/lindangulopez/708181>

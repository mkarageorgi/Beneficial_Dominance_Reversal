---
title: "Comparison of malathion LD50 between Ace genotypes"
author: "Marianna Karageorgi"
date: "2023-06-24"
output: html_document
---

# 1. Data

Starting July 4th 2023, eggs of each D.melanogaster genotype (SS, R1R1, R2R2, R3R3, SR1, SR2, SR3) were exposed to malathion at a range of concentrations diluted in regular Drosophila media (2 trials, 50 eggs/trial).

• dose_ppm = ppm concentration of malathion

• Total = number of eggs exposed per trial

• Alive = number of eggs that survived to adulthood

• Dead = number of eggs that did not survive to adulthood

### Data Wrangling

```{r}
library(tidyverse)
library(data.table)
```

```{r}
viability.range_malathion = fread("./data/Resistance_Data_FINAL.csv")

resistance.data = viability.range_malathion %>%
  
  #create columns alive, total, and dead
  mutate(Alive = rowSums(viability.range_malathion[, 6:15], na.rm = TRUE), 
         Total = 50, 
         Dead = Total - Alive) %>%
    
  mutate(Survival = Alive / Total * 100) %>%
    
  dplyr::rename(Dose = `Dose_(ppm)`) %>%
  
  dplyr::select(Genotype, Replicate, Dose, Alive, Dead, Total, Survival) 
  
resistance.data$Genotype = factor(resistance.data$Genotype,
                                     levels=c("SS","SR1","SR2","SR3","R1R1", "R2R2", "R3R3"))
```

### Summary stats

```{r}
resistance.data.summary = resistance.data %>%
  
  # group replicates 
  group_by(Genotype, Dose) %>%
  
  #summary statistics
  dplyr::summarize(mean_Survival = mean(Survival), 
                   replicates = n(), sd = sd(Survival), 
                   # se = sd / sqrt(2), # i'm not calculating se because size of groups is unequal 
                   .groups = "keep") 
```

### Dose-Response Data: Exploratory Data Analysis

```{r}
library(ggpubr) 
library(ggthemes)

# Define the custom colors for each genotype
genotype_labels = c("S/S", "S/R1", "R1/R1", "S/R2","R2/R2", "S/R3", "R3/R3")
  
# Define the custom colors for the palette
genotype_colors = c("black", "#FCCC1A","#8601AF","#FE2712",  "#FCCC1A", "#8601AF",   "#FE2712")

# Define the linetypes for the λινεσ
linetypes = c(1, 2, 2, 2, 1, 1, 1)

# Define the shapes for each genotype
genotype_shapes = c(16, 1, 16, 1, 16, 1, 16)

resistance_plot = ggplot(data = resistance.data.summary, 
                        aes(x = Dose, y = mean_Survival, color = Genotype, linetype = Genotype)) + 
  
  #this plots for mean of Survival at each dose per Genotype
  geom_line(aes(x = Dose, y = mean_Survival), size = 1, alpha = 1) +
   
  #this plots for standard error of Survival at each dose per Genotype
  geom_errorbar(aes(ymin=mean_Survival-sd, ymax=mean_Survival + sd), width = 0.2) +
  
  # Map the colors to the genotypes
  scale_color_manual(name = "Ace genotype",
                    labels = genotype_labels,
                    values = genotype_colors) +
  
  # Map the linetypes to the genotypes
  scale_linetype_manual(name = "Ace genotype",
                        labels = genotype_labels,
                        values = linetypes) +

  
  scale_x_continuous(breaks=seq(0, 30, 2.5),
                     limits = c(0, 30)) +
  
  scale_y_continuous(breaks=seq(0, 100, 20)) +
  
  labs(x= "Dose (ppm)", y = "Egg to adult viability (%)") +
  
  theme_classic() +
  theme(
    # Increase the size of the axis titles
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    
    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 13, angle = 90, vjust = 0.5),
    axis.text.y = element_text(size = 15),
    
     # Position the legend inside the plot in the upper left hand corner
    legend.position = c(0.99, 0.99),
        legend.background = element_rect(fill = "transparent"),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(3, 3, 3, 3),
        legend.text.align = 0,
        legend.text = element_text(size = 10)
  ) 
  

resistance_plot
```

# 2. Dose response analysis

```{r}
library(drc)
library(broom)

library(kableExtra)
library(htmltools)
library(webshot)
```

-   Fit logistic dose-response curves to the resistance data of each Ace genotype. The drm() function is the key function in the drc package for fitting dose-response curves. Survival is the response variable (y-axis) and Dose is the dose (x-axis). Genotype is the classification variable. data= resistance.data identifies the name of the data file. fct=L.4() is the argument for the logistic curve with four parameters. Here, we fixed two of the parameters, the lower and upper limits, at 0 and 100, respectively. Notice that the drm() function does not produce an output. All the information on the model fit is stored in the object under our defined name resistance.data.model. This will be read by further commands.

-   The summary() function provides a summary of the parameter estimates for the resistance.data.model. In this case, we have constrained the lower and upper limits to 0 and 100, respectively for all datasets. The parameters that are estimated are the slope (b) and the effective dose (e) and their standard errors. The p-values tell us if the parameters are different from zero.

-   The ED() function calculates the estimated effective dose for the resistance data based on the fitted model

### Model data for all genotypes

```{r}
# data for all R genotypes
resistance.data

# Model data for R genotype
model.R = drm(Survival ~ Dose, Genotype,
              data = resistance.data, 
              fct = L.4(fixed = c(NA, 0, 100, NA)))

# Summary of the model
ld50.summary = tidy(model.R)

# Extract ED50 values using the ED() function
ed50_values = ED(model.R, c(50))
```

### Table for LD50 for each genotype

```{r}
# dataframe with estimates
table.Ld50 = ld50.summary %>%
  filter(term == "e") %>%
  rename(Genotype = curve, LD50 = estimate) %>%
  dplyr::select(-term)

# Format the columns
table.Ld50$LD50 = formatC(table.Ld50$LD50, format = "f", digits = 2)
table.Ld50$std.error = formatC(table.Ld50$std.error, format = "f", digits = 2)
table.Ld50$statistic = formatC(table.Ld50$statistic, format = "f", digits = 2)  
table.Ld50$p.value = formatC(table.Ld50$p.value, format = "e", digits = 4)  # 4 decimals for scientific notation


# Use kable to create the table
table.Ld50.kable = table.Ld50 %>%
  kbl(caption = "Dose response curve analysis for each Ace genotype") %>%
  kable_classic(full_width = TRUE, html_font = "Arial") 
   

table.Ld50.kable

# Save the table as an HTML file
save_kable(table.Ld50.kable, file = "./tables/table_drc_LD50.html")

# Use webshot to convert HTML to PDF
webshot("./tables/table_drc_LD50.html", file = "./tables/table_drc_LD50.pdf")
```

### **All Pairwise curve comparisons**

Use a global F test to assess if the parameters of the curves for the two different Ace genotypes are identical. Based on these two models we can calculate an approximate F-test. Then use fdr correction.

```{r}
# Fit a model that does not distinguish among two curves (Model 1). Fit a model which distinguish the dose response curve for each of them (Model 2). Based on these two models then calculate an approximate F-test. Do it for all pairwise comparisons:SS-SR1,SS-R1R1, SR1-R1R1

# Define the pairs of genotypes to compare
genotype_pairs = list(
  c("SS", "SR1"), c("SS", "R1R1"), c("SS", "SR2"), c("SS", "R2R2"), c("SS", "SR3"), c("SS", "R3R3"), c("SR1", "R1R1"), c("SR1", "SR2"), c("SR1", "R2R2"), c("SR1", "SR3"), c("SR1", "R3R3"), c("R1R1", "SR2"), c("R1R1", "R2R2"), c("R1R1", "SR3"), c("R1R1", "R3R3"), c("SR2", "R2R2"), c("SR2", "SR3"), c("SR2", "R3R3"), c("R2R2", "SR3"), c("R2R2", "R3R3"), c("SR3", "R3R3")
)

# Initialize an empty list to store the results
anova_results = list()

# Loop through each pair of genotypes
for (pair in genotype_pairs) {
  # Subset the data for the current pair of genotypes
  subset_data = subset(resistance.data, Genotype %in% pair)
  
  # Fit Model 1: does not distinguish between genotypes
  model1 = drm(Survival ~ Dose, 
                data = subset_data,
                fct = L.4(fixed = c(NA, 0, 100, NA)))
  
  # Fit Model 2: distinguishes between genotypes
  model2 = drm(Survival ~ Dose, Genotype,
                data = subset_data, 
                fct = L.4(fixed = c(NA, 0, 100, NA)))
  
  # Calculate F test
  test_result = tidy(anova(model1, model2))
  
  # Add column to identify the genotype pair being compared
  test_result = test_result %>%
    mutate(Comparison = paste(pair[1], "vs", pair[2]))
  
  # Append the result to the list
  anova_results = c(anova_results, list(test_result))
  
}

# Combine all pairwise comparisons into a single data frame
anova_results.R = do.call(rbind, anova_results)

# perform fdr correction
f.test.fdr = anova_results.R %>%
  
  # Filter for the "2nd model" term
  filter(term == "2nd model") %>%
  
  # Apply FDR correction to the p.value column
  mutate(fdr_corrected = p.adjust(p.value, method = "fdr"))

f.test.fdr
```

### **Predict egg-adult viability using model**

```{r}
# grid of doses and genotypes for which we want predictions
new_doses = expand.grid(Dose = seq(0, 30, by = 0.2), Genotype = unique(resistance.data$Genotype))

# predict survival using the resistance data model
predictions.R = predict(model.R, newdata = new_doses, type = "response")

# attach the predictions to the new_doses data frame
new_doses$Survival = predictions.R
```

### **Predict egg-adult viability at 2.5ppm and 7.5ppm for simulations**

```{r}
# Specify the doses for which predictions are needed
doses = c(2.5, 5, 7.5, 10, 15)

# Create a grid of these specific doses and genotypes for which we want predictions
specific.doses = expand.grid(Dose = doses, Genotype = unique(resistance.data$Genotype))

# Predict survival using the resistance data model
predictions.specific.doses.R = predict(model.R, newdata = specific.doses, type = "response")

# Attach the predictions to the specific_doses data frame
specific.doses$Survival = round(predictions.specific.doses.R,2)

specific.doses 

write_csv(specific.doses, "./data/drc.model.viability.malathion.csv")
```

### **Plot dose response curves**

```{r}
genotype_labels = c(
  expression("S/S"),
  expression("S/R1"),
  expression("S/R2"),
  expression("S/R3"),
  expression("R1/R1"),
  expression("R2/R2"),
  expression("R3/R3")
  )

# Define the custom colors for each genotype
genotype_colors = c("#165094", "#E2BB9B" ,"#EDA09E","#A97DAA","#ce8e58", "#e1615e",  "#702771")


# Define the linetypes for the lines
linetypes = c(1, 2, 2, 2, 1, 1, 1)

# Define the shapes for each genotype
genotype_shapes = c(16, 15, 15,15, 17,17, 17)

Ace.resistance.curves.R = ggplot(data = resistance.data,
       aes(x = Dose, y = Survival, group= Genotype, color= Genotype, linetype = Genotype)) + 
  
  # Annotate to indicate viability at 2.5 and 7.5ppm
annotate("rect", xmin=2.3, xmax=2.7, ymin=-Inf, ymax=Inf, alpha=0.8, fill="#e5e5e5") +
annotate("rect", xmin=7.3, xmax=7.7, ymin=-Inf, ymax=Inf, alpha=0.8, fill="#e5e5e5") +

  geom_point(aes(color=Genotype, shape = Genotype), size = 2) + 
  
  #plot model predictions
  geom_line(data= new_doses, aes(x = Dose, y = Survival, color = Genotype, linetype = Genotype), size = 1) +
  
  
  # Map the colors to the genotypes
  scale_color_manual(name = "Ace genotype",
                    labels = genotype_labels,
                    values = genotype_colors) +
  
  # Map the linetypes to the genotypes
  scale_linetype_manual(name = "Ace genotype",
                        labels = genotype_labels,
                        values = linetypes) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(name = "Ace genotype",
                        labels = genotype_labels,
                        values = genotype_shapes) +

  scale_x_continuous(breaks=seq(0, 30, 2.5),
                     limits = c(-0.5, 30)) +
  
  scale_y_continuous(breaks=seq(0, 100, 10),
                     limits = c(-5,100)) +
  
  labs(title= "", x = "Dose (ppm)",  y = "Egg to adult viability (%)") + 
  
  theme_classic() +
  
  theme(
    # Increase the size of the axis titles
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    
    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 13, angle = 90, vjust = 0.5),
    axis.text.y = element_text(size = 15),
    
     # Position the legend inside the plot in the upper left hand corner
    legend.position = c(0.99, 0.99),
        legend.background = element_rect(fill = "transparent"),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(3, 3, 3, 3),
        legend.text.align = 0,
        legend.text = element_text(size = 10)
  ) 


Ace.resistance.curves.R
ggsave("./plots/Ace.resistance.curves.R.png", Ace.resistance.curves.R, width = 6, height = 4)
```

# 3. Statistics for LD50

```{r}
library(broom)
library(multcomp) 
library(emmeans)
library(msm)
library(boot)
library(ggpubr)
library(boot.pval)
library(modelsummary)
```

Analyze LD50 data.

**Additivity: Comparison between SR vs. (SS+RR)/2**

Additivity is calculated as the difference between the SR genotype and the average of SS and RR genotypes. It can be compared to the expected value under additivity.

-   Expected value under additivity:

    SR- (SS+RR)/2 = proportion_SR -(proportion_SS+proportion_RR)/2

-   Use bootstrap methods to calculate confidence intervals for the additivity estimate, and determine whether the confidence interval includes 0.

-   Significance testing with two one-sided t-test: H0 = the estimate for additivity is 0. Ha1 = the estimate for dominance is higher than 0 Ha2 = the estimate for dominance is lower than 0.

**Selection coefficient: Estimate ratio (RR - SS)/ SS**

The selection coefficient is the ratio of the difference between RR and SS genotypes to the SS genotype. This parameter indicates how selection affects the fitness of the resistant genotype compared to the sensitive genotype.

-   Estimate ratio (RR-SS)/SS = (proportion_RR-proportion_SS)/proportion_SS

-   Use bootstrap methods to calculate confidence intervals for the selection coefficient, and determine whether the confidence interval includes 0.

-   Significance testing with two-sided t-test: H0 = the estimate for selection equals to 0. Ha = the estimate for selection is different from 0.

**Dominance coefficient: Estimate (SR−SS)/(RR−SS) (h)**

The dominance coefficient measures the degree to which the heterozygous genotype (SR) exhibits fitness that is intermediate between the homozygous genotypes (SS and RR).

-   Estimate ratio (proportion_SR-proportion_SS)/(proportion_RR-proportion_SS)

-   Use bootstrap methods to calculate confidence intervals for the dominance coefficient, and determine whether the confidence interval includes 0.5.

-   Significance testing with two one-sided t-test: H0 = the estimate for dominance is 0.5. Ha1 = the estimate for dominance is higher than 0.5. Ha2 = the estimate for dominance is lower than 0.5

### 3.1 Ace R1 genotype

```{r}
# Data for R1
resistance.data.R1 = resistance.data %>% 
  # Filter data 
  filter(Genotype %in% c("SS", "SR1", "R1R1")) %>%
  # Level data so the SS is the ref
  mutate(Genotype = factor(Genotype, levels = c("SS", "SR1", "R1R1")))

# Model data for R1 genotype
model.R1 = drm(Survival ~ Dose, Genotype,
                data = resistance.data.R1, 
                fct = L.4(fixed = c(NA, 0, 100, NA)))

ld50.summary.R1 = tidy(model.R1) %>%
  filter(term == "e") %>%
  rename(Genotype = curve, ld50 = estimate, se = std.error) %>%
  dplyr::select(!term) %>%
  dplyr::mutate(replicate = 2) %>%
  mutate(Genotype = factor(Genotype, levels = c("SS", "SR1", "R1R1")))

# Extract values for table
SS.mean = round(ld50.summary.R1 %>% filter(Genotype == "SS") %>% pull(ld50), 2)
SR1.mean = round(ld50.summary.R1 %>% filter(Genotype == "SR1") %>% pull(ld50), 2)
R1R1.mean = round(ld50.summary.R1 %>% filter(Genotype == "R1R1") %>% pull(ld50), 2)

SS.se = round(ld50.summary.R1 %>% filter(Genotype == "SS") %>% pull(se), 2)
SR1.se = round(ld50.summary.R1 %>% filter(Genotype == "SR1") %>% pull(se), 2)
R1R1.se = round(ld50.summary.R1 %>% filter(Genotype == "R1R1") %>% pull(se), 2)
```

-   **Bootstrapping to calculate confidence intervals**

Define a function that will fit the drm model to a resampled dataset and compute the additivity, selection coefficient, and dominance coefficient and confidence intervals.

```{r}
# Function to fit model, extract LD50, and calculate metrics
bootstrap_function.R1 = function(data, indices) {
  # For each dose and genotype, randomly select one of the two replicates
  d = data %>%
    group_by(Dose, Genotype) %>%
    sample_n(1) %>%  # Randomly select one replicate for each dose/genotype combination
    ungroup()
  
  # Fit the model
  model = drm(Survival ~ Dose, Genotype, data = d, fct = L.4(fixed = c(NA, 0, 100, NA)))
  
  # Extract LD50 estimates
  ld50 = ED(model, 50, interval = "delta") %>%
    as.data.frame() %>%
    rownames_to_column("Genotype")
  
  # Extract LD50 values for each genotype
  ss = ld50$Estimate[ld50$Genotype == "e:SS:50"]
  sr = ld50$Estimate[ld50$Genotype == "e:SR1:50"]
  rr = ld50$Estimate[ld50$Genotype == "e:R1R1:50"]
  
  # Calculate metrics
  deviation_from_additivity = sr - (ss + rr) / 2
  s = (rr - ss) / ss
  h = (sr - ss) / (rr - ss)
  
  # Return calculated metrics
  return(c(ss, sr, rr, additivity = deviation_from_additivity, selection = s, dominance = h))
}

# Set the number of bootstrap resamples
bootstraps = 1000

# Perform bootstrapping
set.seed(123)
result.R1 = boot(data = resistance.data.R1, statistic = bootstrap_function.R1, R = bootstraps)

# Extract the bootstrapped LD50 values
boot_estimates = result.R1$t  # This extracts all the bootstrap replicates

# Pairwise differences for each bootstrap replicate
ss_sr_diff.R1 = boot_estimates[, 1] - boot_estimates[, 2]  # SS - SR1
ss_rr_diff.R1 = boot_estimates[, 1] - boot_estimates[, 3]  # SS - R1R1
sr_rr_diff.R1 = boot_estimates[, 2] - boot_estimates[, 3]  # SR1 - R1R1

# Compute mean pairwise differences
SS.SR1 = round(mean(ss_sr_diff.R1), 2)
SS.R1R1 = round(mean(ss_rr_diff.R1), 2)
SR1.R1R1 = round(mean(sr_rr_diff.R1), 2)

# Standard errors of the differences
SS.SR1.se = round(sd(ss_sr_diff.R1), 2)
SS.R1R1.se = round(sd(ss_rr_diff.R1), 2)
SR1.R1R1.se = round(sd(sr_rr_diff.R1), 2)

# Compute p-values for the pairwise differences based on t-statistics
compute_p_value = function(mean_diff, se_diff, n_boot) {
  t_stat = mean_diff / se_diff
  p_value = 2 * pt(-abs(t_stat), df = n_boot - 1)  # Two-tailed p-value
  return(p_value)
}

# Calculate p-values for pairwise comparisons
SS.SR1.p = round(compute_p_value(SS.SR1, SS.SR1.se, bootstraps),4)
SS.R1R1.p = round(compute_p_value(SS.R1R1, SS.R1R1.se, bootstraps),4)
SR1.R1R1.p = round(compute_p_value(SR1.R1R1, SR1.R1R1.se, bootstraps),4)


# bootstrap values
ss.ld50.R1 = result.R1$t0[1]
sr.ld50.R1 = result.R1$t0[2]
rr.ld50.R1 = result.R1$t0[3]

deviation_additivity.R1 = round(result.R1$t0[4], 2)
selection.R1 = round(result.R1$t0[5], 2)
dominance.R1 = round(result.R1$t0[6], 2)

# Extract bootstrap replicates (bootstrapped statistics)
boot_estimates = result.R1$t  # This extracts all the bootstrap replicates

# Standard errors
se_additivity_R1 = round(sd(boot_estimates[, 4]), 2) # t4 (Additivity)
se_selection_R1 = round(sd(boot_estimates[, 5]), 2) # t5 (Selection Coefficient)
se_dominance_R1 = round(sd(boot_estimates[, 6]), 2) # t6 (Dominance Coefficient)

# Compute p-values for each statistic
pvalue_additivity.R1 = boot.pval(result.R1, index = 4, type = "perc", theta_null = 0)  # p-value for deviation from additivity
pvalue_selection.R1 = boot.pval(result.R1, index = 5, type = "perc", theta_null = 0)   # p-value for selection coefficient
pvalue_dominance.R1 = boot.pval(result.R1, index = 6, type = "perc", theta_null = 0.5)   # p-value for dominance coefficient
```

### 3.2 Ace R2 genotype

```{r}
# Data for R2
resistance.data.R2 = resistance.data %>% 
  # Filter data 
  filter(Genotype %in% c("SS", "SR2", "R2R2")) %>%
  # Level data so the SS is the reference
  mutate(Genotype = factor(Genotype, levels = c("SS", "SR2", "R2R2")))

# Model data for R2 genotype
model.R2 = drm(Survival ~ Dose, Genotype,
                data = resistance.data.R2, 
                fct = L.4(fixed = c(NA, 0, 100, NA)))

ld50.summary.R2 = tidy(model.R2) %>%
  filter(term == "e") %>%
  rename(Genotype = curve, ld50 = estimate, se = std.error) %>%
  dplyr::select(!term) %>%
  dplyr::mutate(replicate = 2) %>%
  mutate(Genotype = factor(Genotype, levels = c("SS", "SR2", "R2R2")))

# Extract values for table
SS.mean = round(ld50.summary.R2 %>% filter(Genotype == "SS") %>% pull(ld50), 2)
SR2.mean = round(ld50.summary.R2 %>% filter(Genotype == "SR2") %>% pull(ld50), 2)
R2R2.mean = round(ld50.summary.R2 %>% filter(Genotype == "R2R2") %>% pull(ld50), 2)

SS.se = round(ld50.summary.R2 %>% filter(Genotype == "SS") %>% pull(se), 2)
SR2.se = round(ld50.summary.R2 %>% filter(Genotype == "SR2") %>% pull(se), 2)
R2R2.se = round(ld50.summary.R2 %>% filter(Genotype == "R2R2") %>% pull(se), 2)
```

-   **Bootstrapping to calculate confidence intervals**

Define a function that will fit the drm model to a resampled dataset and compute the additivity, selection coefficient, and dominance coefficient and confidence intervals.

```{r}
# Function to fit model, extract LD50, and calculate metrics
bootstrap_function.R2 = function(data, indices) {
  # For each dose and genotype, randomly select one of the two replicates
  d = data %>%
    group_by(Dose, Genotype) %>%
    sample_n(1) %>%  # Randomly select one replicate for each dose/genotype combination
    ungroup()
  
  # Fit the model
  model = drm(Survival ~ Dose, Genotype, data = d, fct = L.4(fixed = c(NA, 0, 100, NA)))
  
  # Extract LD50 estimates
  ld50 = ED(model, 50, interval = "delta") %>%
    as.data.frame() %>%
    rownames_to_column("Genotype")
  
  # Extract LD50 values for each genotype
  ss = ld50$Estimate[ld50$Genotype == "e:SS:50"]
  sr = ld50$Estimate[ld50$Genotype == "e:SR2:50"]
  rr = ld50$Estimate[ld50$Genotype == "e:R2R2:50"]
  
  # Calculate metrics
  deviation_from_additivity = sr - (ss + rr) / 2
  s = (rr - ss) / ss
  h = (sr - ss) / (rr - ss)
  
  # Return calculated metrics
  return(c(ss, sr, rr, additivity = deviation_from_additivity, selection = s, dominance = h))
}

# Set the number of bootstrap resamples
bootstraps = 1000

# Perform bootstrapping
set.seed(123)
result.R2 = boot(data = resistance.data.R2, statistic = bootstrap_function.R2, R = bootstraps)

# Extract the bootstrapped LD50 values
boot_estimates = result.R2$t  # This extracts all the bootstrap replicates

# Pairwise differences for each bootstrap replicate
ss_sr_diff.R2 = boot_estimates[, 1] - boot_estimates[, 2]  # SS - SR2
ss_rr_diff.R2 = boot_estimates[, 1] - boot_estimates[, 3]  # SS - R2R2
sr_rr_diff.R2 = boot_estimates[, 2] - boot_estimates[, 3]  # SR2 - R2R2

# Compute mean pairwise differences
SS.SR2 = round(mean(ss_sr_diff.R2), 2)
SS.R2R2 = round(mean(ss_rr_diff.R2), 2)
SR2.R2R2 = round(mean(sr_rr_diff.R2), 2)

# Standard errors of the differences
SS.SR2.se = round(sd(ss_sr_diff.R2), 2)
SS.R2R2.se = round(sd(ss_rr_diff.R2), 2)
SR2.R2R2.se = round(sd(sr_rr_diff.R2), 2)

# Compute p-values for the pairwise differences based on t-statistics
compute_p_value = function(mean_diff, se_diff, n_boot) {
  t_stat = mean_diff / se_diff
  p_value = 2 * pt(-abs(t_stat), df = n_boot - 1)  # Two-tailed p-value
  return(p_value)
}

# Calculate p-values for pairwise comparisons
SS.SR2.p = round(compute_p_value(SS.SR2, SS.SR2.se, bootstraps),4)
SS.R2R2.p = round(compute_p_value(SS.R2R2, SS.R2R2.se, bootstraps),4)
SR2.R2R2.p = round(compute_p_value(SR2.R2R2, SR2.R2R2.se, bootstraps),4)


# bootstrap values
ss.ld50.R2 = result.R2$t0[1]
sr.ld50.R2 = result.R2$t0[2]
rr.ld50.R2 = result.R2$t0[3]

deviation_additivity.R2 = round(result.R2$t0[4], 2)
selection.R2 = round(result.R2$t0[5], 2)
dominance.R2 = round(result.R2$t0[6], 2)

# Extract bootstrap replicates (bootstrapped statistics)
boot_estimates = result.R2$t  # This extracts all the bootstrap replicates

# Standard errors
se_additivity_R2 = round(sd(boot_estimates[, 4]), 2) # t4 (Additivity)
se_selection_R2 = round(sd(boot_estimates[, 5]), 2) # t5 (Selection Coefficient)
se_dominance_R2 = round(sd(boot_estimates[, 6]), 2) # t6 (Dominance Coefficient)

# Compute p-values for each statistic
pvalue_additivity.R2 = boot.pval(result.R2, index = 4, type = "perc", theta_null = 0)  # p-value for deviation from additivity
pvalue_selection.R2 = boot.pval(result.R2, index = 5, type = "perc", theta_null = 0)   # p-value for selection coefficient
pvalue_dominance.R2 = boot.pval(result.R2, index = 6, type = "perc", theta_null = 0.5)   # p-value for dominance coefficient
```

### 3.3 Ace R3 genotype

```{r}
# Data for R3
resistance.data.R3 = resistance.data %>% 
  # Filter data 
  filter(Genotype %in% c("SS", "SR3", "R3R3")) %>%
  # Level data so the SS is the reference
  mutate(Genotype = factor(Genotype, levels = c("SS", "SR3", "R3R3")))

# Model data for R3 genotype
model.R3 = drm(Survival ~ Dose, Genotype,
                data = resistance.data.R3, 
                fct = L.4(fixed = c(NA, 0, 100, NA)))

ld50.summary.R3 = tidy(model.R3) %>%
  filter(term == "e") %>%
  rename(Genotype = curve, ld50 = estimate, se = std.error) %>%
  dplyr::select(!term) %>%
  dplyr::mutate(replicate = 2) %>%
  mutate(Genotype = factor(Genotype, levels = c("SS", "SR3", "R3R3")))

# Extract values for table
SS.mean = round(ld50.summary.R3 %>% filter(Genotype == "SS") %>% pull(ld50), 2)
SR3.mean = round(ld50.summary.R3 %>% filter(Genotype == "SR3") %>% pull(ld50), 2)
R3R3.mean = round(ld50.summary.R3 %>% filter(Genotype == "R3R3") %>% pull(ld50), 2)

SS.se = round(ld50.summary.R3 %>% filter(Genotype == "SS") %>% pull(se), 2)
SR3.se = round(ld50.summary.R3 %>% filter(Genotype == "SR3") %>% pull(se), 2)
R3R3.se = round(ld50.summary.R3 %>% filter(Genotype == "R3R3") %>% pull(se), 2)
```

-   **Bootstrapping to calculate confidence intervals**

Define a function that will fit the drm model to a resampled dataset and compute the additivity, selection coefficient, and dominance coefficient and confidence intervals.

```{r}
# Function to fit model, extract LD50, and calculate metrics
bootstrap_function.R3 = function(data, indices) {
  # For each dose and genotype, randomly select one of the two replicates
  d = data %>%
    group_by(Dose, Genotype) %>%
    sample_n(1) %>%  # Randomly select one replicate for each dose/genotype combination
    ungroup()
  
  # Fit the model
  model = drm(Survival ~ Dose, Genotype, data = d, fct = L.4(fixed = c(NA, 0, 100, NA)))
  
  # Extract LD50 estimates
  ld50 = ED(model, 50, interval = "delta") %>%
    as.data.frame() %>%
    rownames_to_column("Genotype")
  
  # Extract LD50 values for each genotype
  ss = ld50$Estimate[ld50$Genotype == "e:SS:50"]
  sr = ld50$Estimate[ld50$Genotype == "e:SR3:50"]
  rr = ld50$Estimate[ld50$Genotype == "e:R3R3:50"]
  
  # Calculate metrics
  deviation_from_additivity = sr - (ss + rr) / 2
  s = (rr - ss) / ss
  h = (sr - ss) / (rr - ss)
  
  # Return calculated metrics
  return(c(ss, sr, rr, additivity = deviation_from_additivity, selection = s, dominance = h))
}

# Set the number of bootstrap resamples
bootstraps = 1000

# Perform bootstrapping
set.seed(123)
result.R3 = boot(data = resistance.data.R3, statistic = bootstrap_function.R3, R = bootstraps)

# Extract the bootstrapped LD50 values
boot_estimates = result.R3$t  # This extracts all the bootstrap replicates

# Pairwise differences for each bootstrap replicate
ss_sr_diff.R3 = boot_estimates[, 1] - boot_estimates[, 2]  # SS - SR3
ss_rr_diff.R3 = boot_estimates[, 1] - boot_estimates[, 3]  # SS - R3R3
sr_rr_diff.R3 = boot_estimates[, 2] - boot_estimates[, 3]  # SR3 - R3R3

# Compute mean pairwise differences
SS.SR3 = round(mean(ss_sr_diff.R3), 2)
SS.R3R3 = round(mean(ss_rr_diff.R3), 2)
SR3.R3R3 = round(mean(sr_rr_diff.R3), 2)

# Standard errors of the differences
SS.SR3.se = round(sd(ss_sr_diff.R3), 2)
SS.R3R3.se = round(sd(ss_rr_diff.R3), 2)
SR3.R3R3.se = round(sd(sr_rr_diff.R3), 2)

# Compute p-values for the pairwise differences based on t-statistics
compute_p_value = function(mean_diff, se_diff, n_boot) {
  t_stat = mean_diff / se_diff
  p_value = 2 * pt(-abs(t_stat), df = n_boot - 1)  # Two-tailed p-value
  return(p_value)
}

# Calculate p-values for pairwise comparisons
SS.SR3.p =round(compute_p_value(SS.SR3, SS.SR3.se, bootstraps),4)
SS.R3R3.p = round(compute_p_value(SS.R3R3, SS.R3R3.se, bootstraps),4)
SR3.R3R3.p = round(compute_p_value(SR3.R3R3, SR3.R3R3.se, bootstraps),4)


# bootstrap values
ss.ld50.R3 = result.R3$t0[1]
sr.ld50.R3 = result.R3$t0[2]
rr.ld50.R3 = result.R3$t0[3]

deviation_additivity.R3 = round(result.R3$t0[4], 2)
selection.R3 = round(result.R3$t0[5], 2)
dominance.R3 = round(result.R3$t0[6], 2)

# Extract bootstrap replicates (bootstrapped statistics)
boot_estimates = result.R3$t  # This extracts all the bootstrap replicates

# Standard errors
se_additivity_R3 = round(sd(boot_estimates[, 4]), 2) # t4 (Additivity)
se_selection_R3 = round(sd(boot_estimates[, 5]), 2) # t5 (Selection Coefficient)
se_dominance_R3 = round(sd(boot_estimates[, 6]), 2) # t6 (Dominance Coefficient)

# Compute p-values for each statistic
pvalue_additivity.R3 = boot.pval(result.R3, index = 4, type = "perc", theta_null = 0)  # p-value for deviation from additivity
pvalue_selection.R3 = boot.pval(result.R3, index = 5, type = "perc", theta_null = 0)   # p-value for selection coefficient
pvalue_dominance.R3 = boot.pval(result.R3, index = 6, type = "perc", theta_null = 0.5)   # p-value for dominance coefficient
```

# 4. Tables for LD50

## 4.1 Ace R1 genotype

```{r}
library(kableExtra)
library(htmltools)
library(webshot)
```

```{r}
# dataframe with estimates
table.R1 = data.frame(
  Parameter = c("SS mean", "SR1 mean", "R1R1 mean", 
                "SS vs. SR1", "SS vs. R1R1", "SR1 vs. R1R1", 
                "SR1 - (SS + R1R1)/2 (additivity)", 
                "(R1R1 - SS) / R1R1 (selection, s)", "(SR1 - SS) / (R1R1 - SS) (dominance, h)"), 
  LD50 = c(SS.mean, SR1.mean, R1R1.mean, 
                SS.SR1, SS.R1R1, SR1.R1R1, 
                deviation_additivity.R1, selection.R1, dominance.R1), 
  Std.Error = c(SS.se, SR1.se, R1R1.se, 
                SS.SR1.se, SS.R1R1.se, SR1.R1R1.se, 
                se_additivity_R1, se_selection_R1, se_dominance_R1),
  P.value = c("-", "-", "-", SS.SR1.p, SS.R1R1.p, SR1.R1R1.p, 
         pvalue_additivity.R1, pvalue_selection.R1, pvalue_dominance.R1)
)

# Format the columns
table.R1$LD50 = formatC(table.R1$LD50, format = "f", digits = 2)
table.R1$Std.Error = formatC(table.R1$Std.Error, format = "f", digits = 2)
table.R1$P.value = formatC(table.R1$P.value, format = "e", digits = 4)  # 4 decimals for p-values


table.R1.kable = kable(x = table.R1, digits = 4, align = 'l',
                             caption = "<b>Effect estimates from linear model analysis for LD50</b>") %>%
                       kable_classic(full_width = TRUE, html_font = "Times New Roman", font_size = 16) %>%
                       kable_styling(latex_options = c("striped", "hold_position"), position = "center") %>%
                       row_spec(0, bold = TRUE, font_size = 16) %>%  # Make header bold and set font size
                       row_spec(1:nrow(table.R1), font_size = 16)  # Smaller font for values
```

## 4.2 Ace R2 genotype

```{r}
# Dataframe with estimates for R2
table.R2 = data.frame(
  Parameter = c("SS mean", "SR2 mean", "R2R2 mean", 
                "SS vs. SR2", "SS vs. R2R2", "SR2 vs. R2R2", 
                "SR2 - (SS + R2R2)/2 (additivity)", 
                "(R2R2 - SS) / R2R2 (selection, s)", "(SR2 - SS) / (R2R2 - SS) (dominance, h)"), 
  LD50 = c(SS.mean, SR2.mean, R2R2.mean, 
                SS.SR2, SS.R2R2, SR2.R2R2, 
                deviation_additivity.R2, selection.R2, dominance.R2), 
  Std.Error = c(SS.se, SR2.se, R2R2.se, 
                SS.SR2.se, SS.R2R2.se, SR2.R2R2.se, 
                se_additivity_R2, se_selection_R2, se_dominance_R2),
  P.value = c("-", "-", "-", SS.SR2.p, SS.R2R2.p, SR2.R2R2.p, 
         pvalue_additivity.R2, pvalue_selection.R2, pvalue_dominance.R2)
)

# Format the columns
table.R2$LD50 = formatC(table.R2$LD50, format = "f", digits = 2)
table.R2$Std.Error = formatC(table.R2$Std.Error, format = "f", digits = 2)
table.R2$P.value = formatC(table.R2$P.value, format = "e", digits = 4)  # 4 decimals for p-values

# Create and display table
table.R2.kable = kable(x = table.R2, digits = 4, align = 'l',
                             caption = "<b>Effect estimates from linear model analysis for LD50</b>") %>%
                       kable_classic(full_width = TRUE, html_font = "Times New Roman", font_size = 16) %>%
                       kable_styling(latex_options = c("striped", "hold_position"), position = "center") %>%
                       row_spec(0, bold = TRUE, font_size = 16) %>%  # Make header bold and set font size
                       row_spec(1:nrow(table.R2), font_size = 16)  # Smaller font for values

table.R2.kable
```

## 4.3 Ace R3 genotype

```{r}
# Dataframe with estimates for R3
table.R3 = data.frame(
  Parameter = c("SS mean", "SR3 mean", "R3R3 mean", 
                "SS vs. SR3", "SS vs. R3R3", "SR3 vs. R3R3", 
                "SR3 - (SS + R3R3)/2 (additivity)", 
                "(R3R3 - SS) / R3R3 (selection, s)", "(SR3 - SS) / (R3R3 - SS) (dominance, h)"), 
  LD50 = c(SS.mean, SR3.mean, R3R3.mean, 
                SS.SR3, SS.R3R3, SR3.R3R3, 
                deviation_additivity.R3, selection.R3, dominance.R3), 
  Std.Error = c(SS.se, SR3.se, R3R3.se, 
                SS.SR3.se, SS.R3R3.se, SR3.R3R3.se, 
                se_additivity_R3, se_selection_R3, se_dominance_R3),
  P.value = c("-", "-", "-", SS.SR3.p, SS.R3R3.p, SR3.R3R3.p, 
         pvalue_additivity.R3, pvalue_selection.R3, pvalue_dominance.R3)
)

# Format the columns
table.R3$LD50 = formatC(table.R3$LD50, format = "f", digits = 2)
table.R3$Std.Error = formatC(table.R3$Std.Error, format = "f", digits = 2)
table.R3$P.value = formatC(table.R3$P.value, format = "e", digits = 4)  # 4 decimals for p-values

# Create and display table
table.R3.kable = kable(x = table.R3, digits = 4, align = 'l',
                             caption = "<b>Effect estimates from linear model analysis for LD50</b>") %>%
                       kable_classic(full_width = TRUE, html_font = "Times New Roman", font_size = 16) %>%
                       kable_styling(latex_options = c("striped", "hold_position"), position = "center") %>%
                       row_spec(0, bold = TRUE, font_size = 16) %>%  # Make header bold and set font size
                       row_spec(1:nrow(table.R3), font_size = 16)  # Smaller font for values

table.R3.kable
```

## 4.4 R1+R2+R3 Table

```{r}
# remove first row in table 2 and table 3 because it is the same with table 1
table.R1.R2.R3 = rbind(table.R1, table.R2 %>% slice(-1), table.R3 %>% slice(-1))


 
# Use kable to create the table
table.R1.R2.R3.kable = table.R1.R2.R3 %>%
  kbl(caption = "Effect estimates from linear model analysis for LD50") %>%
  kable_classic(full_width = TRUE, html_font = "Arial") 

table.R1.R2.R3.kable

# Save the table as an HTML file
save_kable(table.R1.R2.R3.kable, file = "./tables/table_LD50.html")

# Use webshot to convert HTML to PDF
webshot("./tables/table_LD50.html", file = "./tables/table_LD50.pdf")
```

# 5. Plots for LD50

## 5.1 Ace R1 genotype

```{r}
library("ggpubr")

genotype_labels = c("SS","SR1","R1R1")

# Define the custom colors for each genotype
genotype_colors = c("#165094", "#E2BB9B","#ce8e58")

# Define the shapes for each genotype
genotype_shapes = c(16, 15, 17)


R1_ld50 = ggplot() +
  
  annotate("segment", x = 1, xend = 3, y = 1.394326, yend = 1.559868, colour = "#ce8e58", size=0.5, alpha=0.5) +
  
  # add a line for SS mean
  geom_hline(yintercept = 1.394326, color = "black", linetype = "solid", size = 0.25) +
  
  # This plots the mean ld50 value for each genotype
  geom_point(data = ld50.summary.R1 %>% filter(Genotype %in% c("SS","SR1", "R1R1")),
              aes(x=Genotype, y = ld50, color = Genotype, shape = Genotype), size = 8, alpha = 1) +
  
  
  # This plots the mean and standard error for each genotype
  geom_errorbar(data = ld50.summary.R1 %>% filter(Genotype %in% c("SS", "SR1", "R1R1")),
                aes(x=Genotype, ymin = ld50 - 1.96*se, ymax = ld50 + 1.96*se, color = Genotype), width = 0) +
 
  # Map the colors to the genotypes
  scale_color_manual(values = genotype_colors) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(values = genotype_shapes) +
  
  # Add the s and h coefficients for R1
  geom_text(aes(x = 1.2, y = 15, 
                label = "s = -0.25 +/-0.29 \nh = -1.29 +/-5.10"), 
            size = 8, hjust = 0, vjust = 1) +
  
  scale_y_continuous(breaks = seq(0,15,2.5), 
                     limits = c(0,15)) +
  
  scale_x_discrete(labels = genotype_labels) +
  
  labs(x = "", y = expression(LD[50]~", ppm")) +
  
  theme_classic() +
  
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
 #   panel.background= element_rect(color ="#FCCC1A", size = 2),
    
    # Increase the size of the axis titles
    axis.title.y = element_text(size = 24),

    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 20),
 
    # No legend
    legend.position = "none")


R1_ld50
ggsave("./plots/R1_ld50.png", width = 5 , height = 5)
```

## 5.2 Ace R2 genotypes

```{r}
genotype_labels = c("SS","SR2","R2R2")

# Define the custom colors for each genotype
genotype_colors = c("#165094",  "#e1615e", "#e1615e")


# Define the shapes for each genotype
genotype_shapes = c(16, 15, 17)



R2_ld50 = ggplot() +
  
  annotate("segment", x = 1, xend = 3, y = 1.393999, yend = 8.155493, colour = "#e1615e", size=0.5, alpha=0.5) +
  
  # add a line for SS mean
  geom_hline(yintercept = 1.393999, color = "black", linetype = "solid", size = 0.25) +
  
  # This plots individual values for each genotype
  geom_point(data = ld50.summary.R2 %>% filter(Genotype %in% c("SS","SR2", "R2R2")),
              aes(x=Genotype, y = ld50, color = Genotype, shape = Genotype), size = 8, alpha = 1) +
  
  
  # This plots the mean and standard error for each genotype
  geom_errorbar(data = ld50.summary.R2 %>% filter(Genotype %in% c("SS", "SR2", "R2R2")),
                aes(x=Genotype, ymin = ld50 - 1.96*se, ymax = ld50 + 1.96*se, color = Genotype), width = 0) +
 
  # Map the colors to the genotypes
  scale_color_manual(values = genotype_colors) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(values = genotype_shapes) +
  
 # Add the s and h coefficients for R2
  geom_text(aes(x = 1.2, y = 15, 
                label = "s = 3.83 +/-1.05*** \nh = 0.78 +/-0.06***"), 
            size = 8, hjust = 0, vjust = 1) +
  
  scale_y_continuous(breaks = seq(0,15,2.5), 
                     limits = c(0,15)) +
  
  scale_x_discrete(labels = genotype_labels) +
  
  labs(x = "", y = expression(LD[50]~", ppm")) +
  
  theme_classic() +
  
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
#    panel.background= element_rect(color ="#8601AF", size = 2),
    
   # Increase the size of the axis titles
    axis.title.y = element_text(size = 24),

    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 20),

    # No legend
    legend.position = "none")


R2_ld50 
ggsave("./plots/R2_ld50.png", width = 5 , height = 5)
```

## 5.3 Ace R3 genotypes

```{r}

genotype_labels = c("SS","SR3","R3R3")

# Define the custom colors for each genotype
genotype_colors = c("#165094",  "#702771", "#702771")

# Define the shapes for each genotype
genotype_shapes = c(16, 15, 17)


R3_ld50 = ggplot() +
  
  annotate("segment", x = 1, xend = 3, y = 1.394035, yend = 10.807171, colour =  "#702771", size=0.5, alpha=0.5) +
  
  # add a line for SS mean
  geom_hline(yintercept = 1.394035, color = "black", linetype = "solid", size = 0.25) +
  
  # This plots individual values for each genotype
  geom_point(data = ld50.summary.R3 %>% filter(Genotype %in% c("SS","SR3", "R3R3")),
              aes(x=Genotype, y = ld50, color = Genotype, shape = Genotype), size = 8, alpha = 1) +
  
  
  # This plots the standard error for each genotype
  geom_errorbar(data = ld50.summary.R3 %>% filter(Genotype %in% c("SS", "SR3", "R3R3")),
                aes(x=Genotype, ymin = ld50 - 1.96*se, ymax = ld50 + 1.96*se, color = Genotype), width = 0) +
 
  # Map the colors to the genotypes
  scale_color_manual(values = genotype_colors) +
  
  # Map the shapes to the genotypes
  scale_shape_manual(values = genotype_shapes) +
  
  # Add the s and h coefficients for R2
  geom_text(aes(x = 1.2, y = 15, 
                label = "s = 5.64 +/-1.45*** \nh = 0.77 +/-0.07***"), 
            size = 8, hjust = 0, vjust = 1) +
  
  scale_y_continuous(breaks = seq(0,15,2.5), 
                     limits = c(0,15)) +
  
  scale_x_discrete(labels = genotype_labels) +
  
  labs(x = "", y = expression(LD[50]~", ppm")) +

  
  theme_classic() +
  
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
#    panel.background= element_rect(color ="#FE2712", size = 2),
    
    # Increase the size of the axis titles
    axis.title.y = element_text(size = 24),

    # Increase the size of the axis tick labels
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 20),

    # No legend
    legend.position = "none")


R3_ld50 
ggsave("./plots/R3_ld50.png", width = 5 , height = 5)
```

# 

# 6. References

1.  Drc package and the logistic model:

    <https://doseresponse.github.io/drc/reference/logistic.html>
